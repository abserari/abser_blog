--- 
layout: category-post
title:  "Welcome to blog!"
date:   2016-08-05 20:20:56 -0400
categories: writing
---

é¡¹ç›®åœ°å€ï¼š[https://github.com/yhyddr/quicksilver/tree/master/gosample/caddy-plugin](https://github.com/yhyddr/quicksilver/tree/master/gosample/caddy-plugin)

\-\-\-

\## å‰è¨€
Caddyé™„å¸¦ä¸€ä¸ªHTTPæœåŠ¡å™¨ï¼Œä½†æ˜¯ä½ å¯ä»¥å®ç°å…¶ä»–æœåŠ¡å™¨ç±»å‹å¹¶å°†å®ƒä»¬æ’å…¥Caddyä¸­ã€‚å…¶ä»–ç±»å‹çš„æœåŠ¡å™¨å¯ä»¥æ˜¯SSHã€SFTPã€TCPã€å†…éƒ¨ä½¿ç”¨çš„å…¶ä»–ä¸œè¥¿ç­‰ç­‰ã€‚

å¯¹äºCaddyæ¥è¯´ï¼ŒæœåŠ¡å™¨çš„æ¦‚å¿µæ˜¯ä»»ä½•å¯ä»¥\`Listen()\`å’Œ\`Serve()\`çš„ä¸œè¥¿ã€‚è¿™æ„å‘³ç€ä»€ä¹ˆã€å¦‚ä½•è¿ä½œéƒ½å–å†³äºä½ ã€‚ä½ å¯ä»¥è‡ªç”±åœ°å‘æŒ¥ä½ çš„åˆ›é€ åŠ›å»ä½¿ç”¨å®ƒã€‚

é‚£ä¹ˆæ€æ ·å»æ‰©å±• Caddy å‘¢ï¼Ÿ

ä¸åŒçš„æœåŠ¡å™¨ç±»å‹ï¼Œå¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€è¦å®šåˆ¶ä¸åŒçš„æ’ä»¶ã€‚æˆ‘ä»¬åœ¨è¿™é‡Œï¼Œé€šè¿‡æ·»åŠ æœ€ç®€å•çš„ä¸åšä»»ä½•äº‹çš„æ’ä»¶ï¼Œæ¥ç†Ÿæ‚‰å¦‚ä½•æ‰©å±• Caddy æœåŠ¡å™¨ã€‚

\## Plugin for HTTP
æˆ‘ä»¬ä¼šä¸€æ­¥ä¸€æ­¥æ„å»ºå‡ºä¸€ä¸ª HTTP Plugin çš„æ¡†æ¶ï¼Œåˆ°æ—¶å€™ä½ åªéœ€è¦å¡«å……è‡ªå·±å¤„ç†é€»è¾‘å³å¯ï¼é‚£è¿˜ç­‰ä»€ä¹ˆï¼Œè®©æˆ‘ä»¬å¼€å§‹å§ã€‚

æ„å»ºä¸€ä¸ª HTTP Plugin ï¼Œä»£ç éƒ¨åˆ†ä»…éœ€è¦ä¸¤æ­¥ï¼Œæ³¨æ„äº‹é¡¹ä¹Ÿæœ‰ä¸¤ä¸ªã€‚

\### åˆ›å»ºä¸€ä¸ª Go Package
é¦–å…ˆä¸º caddy åˆ›å»ºä¸€ä¸ª æ’ä»¶çš„ Go Package ï¼Œä½ å¯ä»¥æ–°å»ºä¸€ä¸ªæ–‡ä»¶å¤¹è¾¾åˆ°è¿™ä¸ªæ•ˆæœã€‚æ¯”å¦‚

\`\`\`bash
â”œâ”€â”€ caddy-plugin
â”‚Â Â  â”œâ”€â”€ gizmo.go
â”‚Â Â  â””â”€â”€ setup.go
\`\`\`

è¿™é‡Œåˆ†ä¸ºäº†ä¸¤ä¸ª Go æ–‡ä»¶ï¼Œæ¥ä¸‹æ¥è¯¦ç»†è®²æ¯ä¸€ä¸ª Go æ–‡ä»¶çš„ä½œç”¨ã€‚

\### ä»£ç ğŸ€™ï¼šæ³¨å†Œ caddy plugin
é¦–å…ˆæˆ‘ä»¬çœ‹åˆ° setup.go

\#### setup.go
åˆ›å»º setup.go æ–‡ä»¶å¹¶å†™å…¥ä»¥ä¸‹ä¿¡æ¯
\`\`\`go
import "github.com/mholt/caddy"

func init() {
 caddy.RegisterPlugin("gizmo", caddy.Plugin{
 ServerType: "http",
 Action: setup,
 })
}
\`\`\`
è¿™é‡Œæ˜¯ å»ºç«‹äº†ä¸€ä¸ªæ–°æ’ä»¶ï¼Œcaddy åŒ…æ¥åšåˆ°æ’ä»¶çš„æ³¨å†Œã€‚

1\. æ³¨æ„åˆ° â€œgizmoâ€ è¿™æ˜¯ æ’ä»¶çš„åå­—ï¼ŒåŒæ—¶ä¹Ÿæ˜¯æŒ‡ä»¤çš„åå­—ï¼Œè¯·ä¸ºä½ çš„æ’ä»¶å–ä¸€ä¸ªç‹¬ä¸€æ— äºŒçš„åå­—å§ã€‚ï¼ˆæ³¨æ„ï¼šåå­—éœ€è¦æ˜¯å•è¯å°å†™å“¦ã€‚ï¼‰
1\. å› ä¸ºæ˜¯é’ˆå¯¹ HTTP æœåŠ¡å™¨çš„æ’ä»¶ï¼Œæ‰€ä»¥ ServerType å­—æ®µå€¼æ˜¯ â€œhttpâ€
1\. å¦ä¸€ä¸ªè®¾ç½®çš„å­—æ®µæ˜¯ setup ï¼Œå®é™…ä¸Šï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥ä¼šå¡«å……è¿™ä¸ªå‡½æ•°çš„é€»è¾‘ã€‚å®ƒçš„ä½œç”¨å°±æ˜¯å°†æˆ‘ä»¬æ’ä»¶çš„å¤„ç†é€»è¾‘å®‰è£…åˆ° Caddy ä¸­ã€‚

\#### setup
ç°åœ¨æˆ‘ä»¬æ¥å®ç° setup å‡½æ•°

å‡å¦‚æˆ‘ä»¬å¸Œæœ›åœ¨Caddyfileä¸­æœ‰ä¸€è¡Œè¿™æ ·çš„è¡Œï¼š
\`\`\`
gizmo foobar
\`\`\`

æˆ‘ä»¬å¯ä»¥å¾—åˆ°åˆšæ‰æ‰€è¯´çš„ \`c.Next()\` ç¬¬ä¸€ä¸ªå‚æ•°(â€œfoobarâ€)çš„å€¼ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
\`\`\`go
for c.Next() { // skip the directive name
 if !c.NextArg() { // expect at least one value
 return c.ArgErr() // otherwise it's an error
 }
 value := c.Val() // use the value
}
\`\`\`
æˆ‘ä»¬é¦–å…ˆæ³¨æ„åˆ°ï¼Œ c.Next() æ˜¯çœŸæ­£æˆ‘ä»¬è¯»å– caddyfile é€»è¾‘çš„åœ°æ–¹ï¼Œcaddyfile å°±æ˜¯é…ç½®æœåŠ¡å™¨çš„é…ç½®æ–‡ä»¶çš„åå­—ã€‚æˆ‘ä»¬æ³¨æ„åˆ°ï¼Œè¿™é‡Œçš„æ“ä½œå®é™…ä¸Šæ˜¯ä½¿ç”¨ caddy.Controller æ¥å®ç°çš„ã€‚å®ƒçš„å­˜åœ¨ è®©ç¼–å†™æ’ä»¶çš„å¼€å‘è€…åªéœ€è¦å…³æ³¨å¦‚ä½•ä½¿ç”¨å®ƒæ¥æ‰§è¡Œä½ çš„å‘½ä»¤ï¼Œè¿™æ˜¯ä¸€é¡¹ä¼˜ç§€çš„è®¾è®¡ï¼Œæœ‰å…´è¶£å¯ä»¥çœ‹æˆ‘çš„æºç é˜…è¯»éƒ¨åˆ†å…³äº Plugin çš„å…·ä½“å®ç°ã€‚

åœ¨ Caddy è§£æäº†Caddyfileä¹‹åï¼Œå®ƒå°†è¿­ä»£æ¯ä¸ªæŒ‡ä»¤å(æŒ‰ç…§æœåŠ¡å™¨ç±»å‹è§„å®šçš„é¡ºåº)ï¼Œå¹¶åœ¨æ¯æ¬¡é‡åˆ°æŒ‡ä»¤åæ—¶è°ƒç”¨æŒ‡ä»¤çš„setupå‡½æ•°ã€‚setupå‡½æ•°çš„èŒè´£æ˜¯è§£ææŒ‡ä»¤çš„æ ‡è¯†å¹¶é…ç½®è‡ªå·±ã€‚

æ‚¨å¯ä»¥é€šè¿‡éå†\`c.Next()\`æ¥è§£æä¸ºæŒ‡ä»¤æä¾›çš„æ ‡è¯†ï¼Œåªè¦æœ‰æ›´å¤šçš„æ ‡è¯†éœ€è¦è§£æï¼Œé‚£ä¹ˆ\`c.Next()\`å°±ä¼šè¿”å›\`true\`ã€‚ç”±äºä¸€ä¸ªæŒ‡ä»¤å¯èƒ½å‡ºç°å¤šæ¬¡ï¼Œä½ å¿…é¡»éå†\`c.Next()\`ä»¥è·å¾—æ‰€æœ‰å‡ºç°çš„æŒ‡ä»¤å¹¶ä½¿ç”¨ç¬¬ä¸€ä¸ªæ ‡è¯†(å³æŒ‡ä»¤å)ã€‚

æœ‰å…³caddyfileåŒ…ï¼Œè¯·å‚é˜…[godoc](https://godoc.org/github.com/mholt/caddy/caddyfile)ä»¥äº†è§£å¦‚ä½•æ›´å……åˆ†åœ°ä½¿ç”¨åˆ†å‘å™¨ï¼Œå¹¶æŸ¥çœ‹ä»»ä½•å…¶ä»–ç°æœ‰æ’ä»¶ã€‚

\### ä»£ç  ğŸ€šï¼šHandler å®ç°

\#### gizmo.goï¼š
æŸ¥çœ‹[httpserveråŒ…çš„godoc](http://godoc.org/github.com/mholt/caddy/caddyhttp/httpserver)ã€‚æœ€é‡è¦çš„ä¸¤ç§ç±»å‹æ˜¯[httpserver.Handler](https://godoc.org/github.com/mholt/caddy/caddyhttp/httpserver#Handler)å’Œ[httpserver.Middleware](https://godoc.org/github.com/mholt/caddy/caddyhttp/httpserver#Middleware)ã€‚

1\. \`Handler\`æ˜¯ä¸€ä¸ªå¤„ç†HTTPè¯·æ±‚çš„å‡½æ•°ã€‚
1\. \`Middleware\`æ˜¯ä¸€ç§è¿æ¥\`Handler\`çš„æ–¹å¼ã€‚

Caddyå°†è´Ÿè´£ä¸ºä½ è®¾ç½®HTTPæœåŠ¡å™¨çš„æ‰€æœ‰ç°¿è®°(bookkeeping)å·¥ä½œï¼Œä½†æ˜¯ä½ éœ€è¦å®ç°è¿™ä¸¤ç§ç±»å‹ã€‚

\#### Struct
\`httpserver.Handler\`æ˜¯ä¸€ä¸ªå‡ ä¹å’Œ\`http.Handler\`å®Œå…¨ä¸€æ ·çš„æ¥å£ï¼Œé™¤äº†\`ServeHTTP\`æ–¹æ³•è¿”å›\`(int, error)\`ã€‚

è¿™ä¸ªæ–¹æ³•ç­¾åéµå¾ªGoè¯­è¨€åšå®¢ä¸­[å…³äºä¸ä¸­é—´ä»¶ç›¸å…³çš„é”™è¯¯å¤„ç†çš„å»ºè®®](http://blog.golang.org/error-handling-and-go)ã€‚

\`int\`æ˜¯HTTPçŠ¶æ€ç ï¼Œ\`error\`åº”è¯¥è¢«å¤„ç†å’Œ/æˆ–è®°å½•ã€‚æœ‰å…³è¿™äº›è¿”å›å€¼çš„è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…godocã€‚

\`Handler\`é€šå¸¸æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œè‡³å°‘åŒ…å«ä¸€ä¸ª\`Next\`å­—æ®µï¼Œç”¨æ¥é“¾æ¥ä¸‹ä¸€ä¸ª\`Handler\`ï¼š
\`\`\`go
type gizmoHandler struct {
 next httpserver.Handler
}
\`\`\`

é™¤äº†è¿™äº›ä¹‹å¤–ï¼Œå¯ä»¥æ·»åŠ ä¸€äº›è‡ªå·±ä½¿ç”¨çš„å‚æ•°ï¼Œè€ƒè™‘ grpc çš„ plugin å®ç°ï¼Œè§£é‡Šæ”¾åœ¨ä»£ç å—ä¸­çš„æ³¨é‡Šä¸­
\`\`\`go
type server struct {
 backendAddr string // ç›‘å¬åœ°å€
 next httpserver.Handler // ä½œä¸ºä¸­é—´ä»¶å¿…é¡»æœ‰çš„å­—æ®µ
 backendIsInsecure bool // æ˜¯å¦å¯ç”¨ Insecure() é€‰é¡¹ï¼Œæ˜¯ grpc çš„ä¸€é¡¹é…ç½®
 backendTLS \*tls.Config // å…³äº TLS çš„ä½¿ç”¨çš„è¯ä¹¦æ–‡ä»¶
 wrappedGrpc \*grpcweb.WrappedGrpcServer // é€šè¿‡ grpcweb çš„ åè®®å®ç° HTTP è¯·æ±‚ç­‰
}
\`\`\`
è¿™å°±æ˜¯å‚è€ƒçš„ä¸€ä¸ª å­—æ®µçš„ä½¿ç”¨ã€‚å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€è¦ï¼Œè°ƒæ•´åœ¨ caddyfile ä¸­è¯»å–çš„æŒ‡ä»¤åº”è¯¥å¦‚ä½•é…ç½®ã€‚

\#### httpserver.Handler
ä¸ºäº†å®ç°\`httpserver.Handler\`æ¥å£ï¼Œæˆ‘ä»¬éœ€è¦ç¼–å†™ä¸€ä¸ªåä¸º\`ServeHTTP\`çš„æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•æ˜¯å®é™…çš„å¤„ç†ç¨‹åºå‡½æ•°ï¼Œé™¤éå®ƒè‡ªå·±å¤„ç†å®Œæ¯•è¯·æ±‚ï¼Œå¦åˆ™å®ƒåº”è¯¥è°ƒç”¨é“¾ä¸­çš„ä¸‹ä¸€ä¸ª\`Handler\`ï¼šå³ä½¿ç”¨Â \`g.next.ServeHTTP(w, r)\`
\`\`\`go
func (g gizmoHandler) ServeHTTP(w http.ResponseWriter, r \*http.Request) (int, error) {
 return g.next.ServeHTTP(w, r)
}
\`\`\`
è¿™é‡Œåªæ˜¯æ¡†æ¶ï¼Œå…·ä½“é€»è¾‘å¯ä»¥è‡ªè¡Œå¡«å……ï¼Œå¯ä»¥å‚ç…§å·²æœ‰çš„ Plugin å®ç°ã€‚

\#### ç¬¬äºŒæ­¥ï¼Œæ³¨å†Œ Middleware
ç„¶åæˆ‘ä»¬å¯ä»¥è¿›è¡Œç¬¬äºŒæ­¥ï¼Œå°†è¿™ä¸ª handler æ³¨å†Œåˆ°æ•´ä¸ª caddy çš„ http è°ƒç”¨é“¾ä¸Šã€‚

æˆ‘ä»¬éœ€è¦å›åˆ° åˆšæ‰çš„ setup.go æ–‡ä»¶ä¸­ï¼Œ

å›åˆ°è®¾ç½®å‡½æ•°ã€‚ä½ åˆšåˆšè§£æäº†æ ‡è¯†å¹¶ä½¿ç”¨æ‰€æœ‰é€‚å½“çš„é…ç½®è®¾ç½®äº†ä¸­é—´ä»¶å¤„ç†ç¨‹åºï¼š
\`\`\`go
func setup(c \*caddy.Controller) error {
 g := gizmoHandler{} // ç”¨æ¥å®ç° HTTPHandler çš„ next çš„ç»“æ„ï¼Œç”¨æ¥æ„å»º ä¸­é—´ä»¶ã€‚ä¹Ÿå¯ä»¥åŠ å…¥ä¸€äº›è‡ªå·±çš„å­—æ®µ

 for c.Next() {
 // è·å–é…ç½®æ–‡ä»¶ï¼Œå¹¶å¤„ç†
 }
 // ç°åœ¨å¼€å§‹æ³¨å†Œä¸­é—´ä»¶
 httpserver.GetConfig(c).AddMiddleware(func(next httpserver.Handler) httpserver.Handler {
 g.next = next
 return g
 })

 return nil
}
\`\`\`
è¿™æ ·ï¼Œä»£ç éƒ¨åˆ†å°±å…¨éƒ¨å®Œæˆäº†ã€‚

ä¸‹é¢æˆ‘ä»¬æŸ¥çœ‹éœ€è¦æ³¨æ„çš„äº‹é¡¹ã€‚å®é™…ä¸Šæ˜¯å…³ä¹äºæ€æ ·å°†å†™å¥½çš„æ’ä»¶é›†æˆåœ¨ caddy ä¸­ã€‚

\### æ’åº
è¦åšçš„äº‹æƒ…æ˜¯å‘Šè¯‰æœåŠ¡å™¨ç±»å‹åœ¨è¿›ç¨‹çš„ä»€ä¹ˆåœ°æ–¹æ‰§è¡Œä½ çš„æŒ‡ä»¤ã€‚è¿™ä¸€ç‚¹å¾ˆé‡è¦ï¼Œå› ä¸ºå…¶ä»–æŒ‡ä»¤å¯èƒ½ä¼šè®¾ç½®ä½ æ‰€ä¾èµ–çš„æ›´åŸå§‹çš„é…ç½®ï¼Œå› æ­¤æ‰§è¡ŒæŒ‡ä»¤çš„é¡ºåºä¸èƒ½æ˜¯éšæ„çš„ã€‚

æ¯ä¸ªæœåŠ¡å™¨ç±»å‹éƒ½æœ‰ä¸€ä¸ªå­—ç¬¦ä¸²åˆ—è¡¨ï¼Œå…¶ä¸­æ¯ä¸ªé¡¹éƒ½æ˜¯ä¸€ä¸ªæŒ‡ä»¤çš„åç§°ã€‚ä¾‹å¦‚ï¼ŒæŸ¥çœ‹[HTTPæœåŠ¡å™¨æ”¯æŒçš„æŒ‡ä»¤åˆ—è¡¨](https://github.com/mholt/caddy/blob/d3860f95f59b5f18e14ddf3d67b4c44dbbfdb847/caddyhttp/httpserver/plugin.go#L314-L355)ã€‚å°†æŒ‡ä»¤æ·»åŠ åˆ°é€‚å½“çš„ä½ç½®ã€‚

\## æ’å…¥ä½ çš„æ’ä»¶
æœ€åï¼Œä¸è¦å¿˜è®°å¯¼å…¥ä½ çš„æ’ä»¶åŒ…ï¼Caddyå¿…é¡»å¯¼å…¥æ’ä»¶æ¥æ³¨å†Œå¹¶æ‰§è¡Œå®ƒã€‚è¿™é€šå¸¸æ˜¯åœ¨[run.go](https://github.com/mholt/caddy/blob/master/caddy/caddymain/run.go)çš„\`import\`éƒ¨åˆ†çš„å°¾éƒ¨å®Œæˆçš„ï¼š

\`\`\`go
\_ "your/plugin/package/here"
\`\`\`

è¯·æ³¨æ„ï¼šåŒ…åå‰çš„\`\_\`æ˜¯å¿…éœ€çš„ã€‚

\## æ€»ç»“
å°±æ˜¯è¿™æ ·ï¼å¯ä»¥ç”¨ä½ çš„æ’ä»¶æ¥æ„å»ºcaddyï¼Œç„¶åç”¨ä½ çš„æ–°æŒ‡ä»¤å†™ä¸€ä¸ªCaddyfileæ¥æŸ¥çœ‹å®ƒçš„è¿è¡Œæƒ…å†µã€‚

è™½ç„¶è¿˜æ²¡å®Œå–„çš„å¥¹åªæ˜¯ä¸€ä¸ªæ¡†æ¶ï¼Œè¿˜ä¸èƒ½åšä»»ä½•äº‹æƒ…ï¼Œä½†æ˜¯å¥¹å¾ˆç®€å•ï¼Œå¾ˆç¾ä¸æ˜¯å—ï¼Ÿå¥¹èƒ½å¸®ä½ åšä»»ä½•äº‹æƒ…ã€‚å› ä¸ºè®°ä½ caddy çš„æœåŠ¡å™¨æ˜¯è®¾ç½®çš„éå¸¸æŠ½è±¡çš„ã€‚å¥¹å°±æƒ³ net åŒ…ä¸­ conn ä¸€æ ·å®Œç¾çš„ æ¥å£è®¾è®¡ï¼Œèƒ½å¤Ÿå…¼å®¹å’Œæ‰©å±•ä»»ä½• éœ€è¦ listen()Â  å’Œ serve() çš„ä¸œè¥¿ï¼Œåªè¦ä½ çš„åˆ›é€ åŠ›è¶³å¤Ÿã€‚

ç°åœ¨ï¼Œå‘æŒ¥ä½ çš„æƒ³è±¡åŠ›ï¼Œå¡«å……è¿™ä¸ªæ¡†æ¶å§ï¼Œå¯ä»¥å‚è€ƒæˆ‘çš„ç®€å•é¡¹ç›®åœ°å€ã€‚

é¡¹ç›®åœ°å€ï¼š[https://github.com/yhyddr/quicksilver/tree/master/gosample/caddy-plugin](https://github.com/yhyddr/quicksilver/tree/master/gosample/caddy-plugin)

åŒæ—¶è®°å¾—å¤šå¤šå¯»æ‰¾åˆ«äººçš„æ’ä»¶å®ç°æ–¹å¼ï¼Œä½ ä¼šæ‰¾åˆ°è®©ä½ è€³ç›®ä¸€æ–°çš„å®ç°ã€‚[https://www.yuque.com/fengyfei/idznuk/sumapn](https://www.yuque.com/fengyfei/idznuk/sumapn)

\## å‚è€ƒ
![image.png](assert/1565363529670-bb10335a-9c42-41b6-9098-8230757271df.png)

æˆ‘åˆšç¼–è¾‘è¿‡å“¦

[https://github.com/caddyserver/caddy/wiki/Writing-a-Plugin:-Directives](https://github.com/caddyserver/caddy/wiki/Writing-a-Plugin:-Directives)

[https://github.com/caddyserver/caddy/wiki/Writing-a-Plugin:-Server-Type](https://github.com/caddyserver/caddy/wiki/Writing-a-Plugin:-Server-Type)

[https://github.com/caddyserver/caddy/wiki/Writing-a-Plugin:-HTTP-Middleware](https://github.com/caddyserver/caddy/wiki/Writing-a-Plugin:-HTTP-Middleware)